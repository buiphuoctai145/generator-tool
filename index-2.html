
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Tr√¨nh t·∫°o Cases (marker key ƒë·ªông, kh√¥ng b·∫£ng)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
            --danger:#ef4444; --border:#1f2937; --chip:#0b1020; --chip-border:#1f2937; --btn:#162235; }
    html, body { background: var(--bg); color: var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif; margin:0; }
    .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
    h1 { font-size: 1.6rem; margin: 0 0 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:18px; }
    label { font-size: 0.9rem; color: var(--muted); }
    .controls { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    button { padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--text); cursor:pointer; }
    .primary{ background:#0b3b1f; border-color:#134e4a; } .accent{ background:#0b2550; border-color:#1f3b77; }
    .danger{ background:#3a0b0b; border-color:#5b1a1a; color:#fecaca; } .muted{ color:var(--muted); }
    input[type="text"]{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); background:#0b1020; color:var(--text); outline:none; }
    .stat{ margin-top:8px; color:var(--muted); }
    .code{ background:#0b1020; border:1px solid var(--border); border-radius:12px; padding:12px; white-space:pre; overflow:auto;
           font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:0.9rem; }

    /* Command block */
    .cmd-block{ border:1px dashed var(--border); border-radius:12px; padding:12px; margin-top:12px; }
    .cmd-header{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; }
    .cmd-name.error{ border-color:var(--danger); box-shadow:0 0 0 2px rgba(239,68,68,.18); }

    /* Marker row (2 input: key + value) */
    .marker-row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:center; margin:8px 0 12px; }
    .marker-hint{ font-size:0.85rem; color:var(--muted); margin-top:-6px; }

    /* Condition row */
    .cond-row{ display:grid; grid-template-columns: 1.2fr 2.2fr auto; gap:12px; align-items:start; margin-bottom:8px; }
    .cond-name.error{ border-color:var(--danger); box-shadow:0 0 0 2px rgba(239,68,68,.18); }
    .values-wrap{ display:flex; flex-wrap:wrap; gap:8px; }
    .value-chip{ display:inline-flex; align-items:center; gap:6px; background:var(--chip); border:1px solid var(--chip-border); border-radius:10px; padding:6px 8px; }
    .value-chip input{ width:160px; max-width:40vw; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0a0f1e; color:var(--text); outline:none; }
    .remove-btn{ border:1px solid var(--border); border-radius:6px; background:#1f2937; color:#fecaca; padding:6px 8px; cursor:pointer; }
    .cond-actions{ display:flex; gap:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tr√¨nh t·∫°o Cases (Marker key nh·∫≠p ƒë·ªông, ch√®n CU·ªêI, kh√¥ng tham gia t·ªï h·ª£p)</h1>

    <!-- Equipment type -->
    <div class="card">
      <label for="equipmentTypeName">Equipment Type Name</label>
      <input id="equipmentTypeName" type="text" placeholder='V√≠ d·ª•: Emergency Lighting Panel' />
    </div>

    <!-- Commands -->
    <div class="card">
      <div class="controls">
        <button class="primary" id="addCommand">‚ûï Th√™m Command</button>
        <button id="loadSample">üì• N·∫°p v√≠ d·ª•</button>
        <button class="danger" id="clearAll">üóëÔ∏è X√≥a t·∫•t c·∫£ Commands</button>
      </div>
      <div id="commandsContainer"></div>
      <p class="muted">M·ªói Command c√≥ Conditions ri√™ng (Values linh ƒë·ªông). Nh·∫≠p ‚ÄúMarker key‚Äù v√† ‚ÄúMarker value‚Äù: marker s·∫Ω **ch√®n CU·ªêI** m·ªçi case nh∆∞ng **kh√¥ng** tham gia t·ªï h·ª£p.</p>
    </div>

    <!-- Generate & Export -->
    <div class="card">
      <div class="controls">
        <button class="primary" id="generate">üöÄ T·∫°o cases</button>
        <button id="downloadJSON" disabled>‚¨áÔ∏è JSON</button>
        <button id="downloadYAML" disabled>‚¨áÔ∏è YAML</button>
        <button id="copyYAML" disabled>üìã Copy YAML</button>
      </div>
      <div id="stats" class="stat"></div>
      <div id="yamlBlock" class="code" style="display:none;"></div>
    </div>
  </div>

  <script>
    // ====== Ti·ªán √≠ch DOM ======
    const el = sel => document.querySelector(sel);
    const make = (tag, attrs = {}, children = []) => {
      const node = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => { if (k === 'class') node.className = v; else if (k === 'text') node.textContent = v; else node.setAttribute(k, v); });
      children.forEach(c => node.appendChild(c));
      return node;
    };

    const commandsContainer = el('#commandsContainer');

    // ====== Command block (marker key + value; conditions ri√™ng) ======
    function addCommandBlock({ name = '', markerKey = '', markerValue = '', conditions = [] } = {}) {
      const block = make('div', { class: 'cmd-block' });

      // Header: Command name + actions
      const header = make('div', { class: 'cmd-header' });
      const nameInput = make('input', { class: 'cmd-name', type: 'text', placeholder: 'Command name (v√≠ d·ª•: On Control)' });
      nameInput.value = name;

      const headerActions = make('div', { class: 'controls' });
      const addCondBtn = make('button', { class: 'accent', text: '‚ûï Condition' });
      const removeCmdBtn = make('button', { class: 'danger', text: 'X√≥a Command' });
      headerActions.append(addCondBtn, removeCmdBtn);
      header.append(nameInput, headerActions);

      // Marker (2 input: key + value) ‚Äî value c√≥ th·ªÉ ƒë·ªÉ tr·ªëng
      const markerRow = make('div', { class: 'marker-row' });
      const markerKeyIn = make('input', { class: 'marker-key', type: 'text', placeholder: 'Marker key (v√≠ d·ª•: bOnOffCmd)' });
      const markerValIn = make('input', { class: 'marker-value', type: 'text', placeholder: 'Marker value (v√≠ d·ª•: abc, c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)' });
      markerKeyIn.value = markerKey;
      markerValIn.value = markerValue;
      const markerHint = make('div', { class: 'marker-hint', text: 'Marker s·∫Ω ch√®n CU·ªêI m·ªçi case c·ªßa Command n√†y; KH√îNG tham gia t·ªï h·ª£p.' });

      // Conditions list
      const condList = make('div');

      function addConditionRow({ name = '', values = ['Off', 'On'] } = {}) {
        const row = make('div', { class: 'cond-row' });
        const condName = make('input', { class: 'cond-name', type: 'text', placeholder: 'T√™n ƒëi·ªÅu ki·ªán (v√≠ d·ª•: bRemoteStatus)' });
        condName.value = name;

        const valuesWrap = make('div', { class: 'values-wrap' });
        const addValueChip = (val = '') => {
          const chip = make('div', { class: 'value-chip' });
          const input = make('input', { type: 'text', placeholder: 'Gi√° tr·ªã' });
          input.value = val;
          const removeBtn = make('button', { class: 'remove-btn', text: '√ó' });
          removeBtn.title = 'X√≥a gi√° tr·ªã n√†y';
          removeBtn.addEventListener('click', () => chip.remove());
          chip.append(input, removeBtn);
          valuesWrap.appendChild(chip);
        };
        if (!Array.isArray(values) || values.length === 0) values = ['Off', 'On'];
        values.forEach(v => addValueChip(v));

        const actions = make('div', { class: 'cond-actions' });
        const addValBtn = make('button', { class: 'accent', text: '‚ûï Gi√° tr·ªã' });
        const removeCondBtn = make('button', { class: 'danger', text: 'X√≥a ƒëi·ªÅu ki·ªán' });
        addValBtn.addEventListener('click', () => addValueChip(''));
        removeCondBtn.addEventListener('click', () => row.remove());

        // realtime validate tr√πng t√™n trong ph·∫°m vi command n√†y
        condName.addEventListener('input', () => validateUniqueConditionNames(block, true));

        row.append(condName, valuesWrap, actions);
        actions.append(addValBtn, removeCondBtn);
        condList.appendChild(row);
      }

      addCondBtn.addEventListener('click', () => { addConditionRow(); validateUniqueConditionNames(block, true); });
      removeCmdBtn.addEventListener('click', () => { block.remove(); validateUniqueCommandNames(true); });

      // Render
      block.append(header, markerRow, condList, markerHint);
      commandsContainer.appendChild(block);

      // N·∫°p ƒëi·ªÅu ki·ªán s·∫µn c√≥ (n·∫øu c√≥)
      (conditions || []).forEach(c => addConditionRow(c));

      // Validate realtime cho command name
      nameInput.addEventListener('input', () => validateUniqueCommandNames(true));
    }

    // ====== ƒê·ªçc to√†n b·ªô c·∫•u h√¨nh ======
    function readAll() {
      const equipmentTypeName = (el('#equipmentTypeName').value || '').trim();
      const commands = [...commandsContainer.querySelectorAll('.cmd-block')].map(block => {
        const cmdName = (block.querySelector('.cmd-name').value || '').trim();
        const markerKey = (block.querySelector('.marker-key')?.value || '').trim();
        const markerValue = (block.querySelector('.marker-value')?.value || '').trim();

        const condRows = [...block.querySelectorAll('.cond-row')];
        const conds = condRows.map(row => {
          const nameEl = row.querySelector('.cond-name');
          if (!nameEl) return null;
          const name = (nameEl.value || '').trim();
          const values = [...row.querySelectorAll('.value-chip input')]
            .map(inp => (inp.value || '').trim())
            .filter(Boolean);
          return { name, values };
        }).filter(Boolean).filter(c => c.name.length > 0);

        return { name: cmdName, markerKey, markerValue, conds };
      }).filter(cmd => cmd.name.length > 0);
      return { equipmentTypeName, commands };
    }

    // ====== Validation ======
    const normalize = s => (s || '').trim().toLowerCase();

    function validateUniqueCommandNames(showHints = true) {
      const inputs = [...commandsContainer.querySelectorAll('.cmd-name')];
      const counters = new Map();
      inputs.forEach(inp => { inp.classList.remove('error'); inp.removeAttribute('title'); });
      inputs.forEach(inp => { const n = normalize(inp.value); if (!n) return; counters.set(n, (counters.get(n)||0)+1); });
      let dup = false;
      if (showHints) {
        inputs.forEach(inp => {
          const n = normalize(inp.value); if (!n) return;
          if ((counters.get(n)||0) > 1) { dup = true; inp.classList.add('error'); inp.title = 'T√™n Command tr√πng'; }
        });
      } else { counters.forEach(cnt => { if (cnt > 1) dup = true; }); }
      return { ok: !dup };
    }

    function validateUniqueConditionNames(commandBlock, showHints = true) {
      const inputs = [...commandBlock.querySelectorAll('.cond-name')];
      const counters = new Map();
      inputs.forEach(inp => { inp.classList.remove('error'); inp.removeAttribute('title'); });
      inputs.forEach(inp => { const n = normalize(inp.value); if (!n) return; counters.set(n, (counters.get(n)||0)+1); });
      let dup = false;
      if (showHints) {
        inputs.forEach(inp => {
          const n = normalize(inp.value); if (!n) return;
          if ((counters.get(n)||0) > 1) { dup = true; inp.classList.add('error'); inp.title = 'T√™n ƒëi·ªÅu ki·ªán tr√πng trong Command'; }
        });
      } else { counters.forEach(cnt => { if (cnt > 1) dup = true; }); }
      return { ok: !dup };
    }

    // ====== Combinator (mixed‚Äëradix; cho ph√©p 1 value) ======
    function generateCombinationsForCommand(conds) {
      if (!Array.isArray(conds) || conds.length === 0) return [];
      // M·ªói Condition c·∫ßn >= 1 value (ƒë∆∞·ª£c ph√©p = 1)
      for (const c of conds) {
        if (!Array.isArray(c.values) || c.values.length < 1) {
          throw new Error(`ƒêi·ªÅu ki·ªán "${c.name}" ph·∫£i c√≥ √≠t nh·∫•t 1 gi√° tr·ªã (c√≥ th·ªÉ l√† h·∫±ng).`);
        }
      }
      const radices = conds.map(c => c.values.length);
      const total = radices.reduce((acc, k) => acc * k, 1);
      const out = []; const idxs = Array(conds.length).fill(0);
      for (let t = 0; t < total; t++) {
        const one = {};
        for (let i = 0; i < conds.length; i++) one[conds[i].name] = conds[i].values[idxs[i]];
        out.push(one);
        for (let i = conds.length - 1; i >= 0; i--) { idxs[i]++; if (idxs[i] < radices[i]) break; idxs[i] = 0; }
      }
      return out;
    }

    // ====== Stats ======
    function updateStats(equipmentTypeName, commandsCasesMap) {
      const cmds = Object.keys(commandsCasesMap);
      const totalCommands = cmds.length;
      const totalCases = cmds.reduce((acc, k) => acc + (commandsCasesMap[k].length || 0), 0);
      const perCmd = cmds.map(k => `${k}: ${commandsCasesMap[k].length} cases`).join(' ¬∑ ');
      el('#stats').textContent =
        `Equipment Type: ${equipmentTypeName || '(ch∆∞a nh·∫≠p)'} ¬∑ Commands: ${totalCommands} ¬∑ T·ªïng cases: ${totalCases}` +
        (perCmd ? ` ¬∑ ${perCmd}` : '');
    }

    // ====== YAML / JSON ======
    function yamlQuoteAlways(str) { const s = String(str ?? ''); return `"${s.replace(/"/g, '\\"')}"`; }
    function yamlPlain(str) { return str == null ? '' : String(str); }

    function toYAML(equipmentTypeName, commandsCasesMap) {
      const lines = [];
      lines.push(`EquipmentTypes:`);
      lines.push(`  - Name: ${yamlQuoteAlways((equipmentTypeName || 'Equipment').trim())}`); // CH·ªà d√≤ng n√†y c√≥ d·∫•u "

      lines.push(`    Commands:`);
      Object.entries(commandsCasesMap).forEach(([cmdName, cases]) => {
        lines.push(`      - Name: ${(cmdName || 'Command').trim()}`);  // KH√îNG quote
        lines.push(`        Scenarios:`);
        cases.forEach((c, idx) => {
          lines.push(`          - Name: Case ${idx + 1}`);             // KH√îNG quote
          lines.push(`            Conditions:`);
          // Duy tr√¨ th·ª© t·ª± ch√®n thu·ªôc t√≠nh trong object ƒë·ªÉ marker l√† CU·ªêI c√πng
          Object.entries(c).forEach(([k, v]) => {
            lines.push(`              ${k}: ${yamlPlain(v)}`);
          });
        });
      });
      return lines.join('\n');
    }

    function toJSON(equipmentTypeName, commandsCasesMap) {
      return JSON.stringify({
        EquipmentTypes: [
          {
            Name: equipmentTypeName || 'Equipment',
            Commands: Object.entries(commandsCasesMap).map(([cmdName, cases]) => ({
              Name: cmdName || 'Command',
              Scenarios: cases.map((c, idx) => ({ Name: `Case ${idx + 1}`, Conditions: c }))
            }))
          }
        ]
      }, null, 2);
    }

    function enableExports(enabled) {
      ['downloadJSON','downloadYAML','copyYAML'].forEach(id => el('#' + id).disabled = !enabled);
    }

    function download(filename, content, mime = 'text/plain') {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
    }

    // ====== Events ======
    el('#addCommand').addEventListener('click', () => addCommandBlock());
    el('#clearAll').addEventListener('click', () => { commandsContainer.innerHTML = ''; });

    el('#loadSample').addEventListener('click', () => {
      commandsContainer.innerHTML = '';
      // V√≠ d·ª• 1: On Control (c√≥ marker key + value)
      addCommandBlock({
        name: 'On Control',
        markerKey: 'bOnOffCmd',
        markerValue: 'abc',     // c√≥ th·ªÉ ƒë·ªÉ tr·ªëng
        conditions: [
          { name: 'bOnOffStatus', values: ['Off', 'On'] },
          { name: 'bRemoteStatus', values: ['Local', 'Remote'] },
          { name: 'bTripAlarm', values: ['Alarmed', 'Normal'] }
        ]
      });
      // V√≠ d·ª• 2: Off Control (ch·ªâ key, value tr·ªëng)
      addCommandBlock({
        name: 'Off Control',
        markerKey: 'bOnOffCmd',
        markerValue: '',
        conditions: [
          { name: 'bOnOffStatus', values: ['Off', 'On'] },
          { name: 'bRemoteStatus', values: ['Local', 'Remote'] }
        ]
      });
      el('#equipmentTypeName').value = 'Emergency Lighting Panel';
    });

    let lastEquipmentType = '', lastCommandsCasesMap = {};

    el('#generate').addEventListener('click', () => {
      // Validate tr√πng Command
      if (!validateUniqueCommandNames(true).ok) { alert('C√≥ Command Name tr√πng. H√£y s·ª≠a tr∆∞·ªõc khi t·∫°o cases.'); return; }
      // Validate tr√πng Condition trong t·ª´ng Command
      const blocks = [...commandsContainer.querySelectorAll('.cmd-block')];
      for (const b of blocks) {
        const v = validateUniqueConditionNames(b, true);
        if (!v.ok) { alert('C√≥ t√™n ƒëi·ªÅu ki·ªán tr√πng trong m·ªôt Command. H√£y s·ª≠a tr∆∞·ªõc khi t·∫°o cases.'); return; }
      }

      const { equipmentTypeName, commands } = readAll();
      if (!equipmentTypeName) { alert('Vui l√≤ng nh·∫≠p Equipment Type Name.'); return; }
      if (commands.length === 0) { alert('Vui l√≤ng th√™m √≠t nh·∫•t 1 Command.'); return; }

      const commandsCasesMap = {};
      try {
        for (const cmd of commands) {
          if (!Array.isArray(cmd.conds) || cmd.conds.length === 0) {
            throw new Error(`Command "${cmd.name}" ch∆∞a c√≥ ƒëi·ªÅu ki·ªán n√†o.`);
          }
          // C·∫£nh b√°o n·∫øu marker key ƒë·ª•ng t√™n Condition (tr√°nh override)
          if (cmd.markerKey) {
            const hit = cmd.conds.some(c => normalize(c.name) === normalize(cmd.markerKey));
            if (hit) {
              alert(`Marker key "${cmd.markerKey}" c·ªßa Command "${cmd.name}" tr√πng t√™n m·ªôt Condition. Vui l√≤ng ƒë·ªïi key ƒë·ªÉ tr√°nh ghi ƒë√®.`);
              return;
            }
          }

          // 1) Sinh t·ªï h·ª£p theo ch√≠nh conditions c·ªßa command
          let cases = generateCombinationsForCommand(cmd.conds);

          // 2) Ch√®n marker n·∫øu c√≥ key (value c√≥ th·ªÉ tr·ªëng). Ch√®n SAU C√ôNG b·∫±ng insertion order.
          if (cmd.markerKey && cmd.markerKey.length > 0) {
            const key = cmd.markerKey;
            const val = (cmd.markerValue ?? '');
            cases = cases.map(one => ({ ...one, [key]: val })); // key n·∫±m CU·ªêI
          }

          // L∆∞u
          commandsCasesMap[cmd.name] = cases;
        }
      } catch (e) {
        alert(e.message || 'C√≥ l·ªói x·∫£y ra khi sinh t·ªï h·ª£p.');
        return;
      }

      // Stats + YAML/JSON
      updateStats(equipmentTypeName, commandsCasesMap);
      const yaml = toYAML(equipmentTypeName, commandsCasesMap);
      el('#yamlBlock').textContent = yaml;
      el('#yamlBlock').style.display = 'block';

      lastEquipmentType = equipmentTypeName;
      lastCommandsCasesMap = commandsCasesMap;
      enableExports(true);
    });

    el('#downloadJSON').addEventListener('click', () => {
      const json = toJSON(lastEquipmentType, lastCommandsCasesMap);
      const baseET = (lastEquipmentType || 'Equipment').replace(/[^\w\-]+/g,'_');
      download(`${baseET}_cases.json`, json, 'application/json');
    });

    el('#downloadYAML').addEventListener('click', () => {
      const yaml = toYAML(lastEquipmentType, lastCommandsCasesMap);
      const baseET = (lastEquipmentType || 'Equipment').replace(/[^\w\-]+/g,'_');
      download(`${baseET}_cases.yaml`, yaml, 'text/yaml');
    });

    el('#copyYAML').addEventListener('click', async () => {
      const yaml = toYAML(lastEquipmentType, lastCommandsCasesMap);
      try { await navigator.clipboard.writeText(yaml); alert('ƒê√£ copy YAML v√†o clipboard!'); }
      catch { alert('Tr√¨nh duy·ªát kh√¥ng cho ph√©p copy t·ª± ƒë·ªông. H√£y ch·ªçn & copy th·ªß c√¥ng.'); }
    });

    // Kh·ªüi t·∫°o m·∫∑c ƒë·ªãnh
    addCommandBlock({ name: 'On Control', markerKey: 'bOnOffCmd', markerValue: 'abc', conditions: [{ name: 'bOnOffStatus', values: ['Off','On'] }] });
  </script>
</body>
</html>
